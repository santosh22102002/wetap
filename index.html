<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MOBA COIN</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCO-X24uZxjrJEI1JIwDM3zKFISjJQ28NY",
  authDomain: "mobacoin.firebaseapp.com",
  databaseURL: "https://mobacoin-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mobacoin",
  storageBucket: "mobacoin.firebasestorage.app",
  messagingSenderId: "275511190304",
  appId: "1:275511190304:web:2f255f34cda417cbb5ed45",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe.user;
if(!user) alert("Open inside Telegram");

const userId = user.id.toString();
const username = user.username || "Player";

let coins = 0;
let energy = 500;
let maxEnergy = 500;
let boostActive = false;
let boostCooldown = false;

const seasonEnd = getNextSunday();

function getNextSunday(){
    let now = new Date();
    let day = now.getDay();
    let diff = 7 - day;
    let sunday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
    sunday.setHours(23,59,59,0);
    return sunday;
}

async function initPlayer(){
    const playerRef = doc(db,"players",userId);
    const snap = await getDoc(playerRef);

    if(!snap.exists()){
        await setDoc(playerRef,{
            username: username,
            coins: 0,
            energy: 500,
            season: 1,
            lastRefill: Date.now()
        });
    }

    onSnapshot(playerRef,(doc)=>{
        const data = doc.data();
        coins = data.coins;
        energy = data.energy;
        updateUI();
    });
}

function updateUI(){
    document.getElementById("coinDisplay").innerText = coins;
    document.getElementById("energyDisplay").innerText = energy+"/"+maxEnergy;
    document.getElementById("energyBar").style.width = (energy/maxEnergy*100)+"%";
}

async function tap(){
    if(energy <= 0) return showEnergyPopup();

    let add = boostActive ? 5 : 1;

    const playerRef = doc(db,"players",userId);
    await updateDoc(playerRef,{
        coins: coins + add,
        energy: energy - 1
    });

    showFloating(add);
}

function showFloating(val){
    const float = document.createElement("div");
    float.className="float";
    float.innerText="+"+val;
    document.body.appendChild(float);
    setTimeout(()=>float.remove(),1000);
}

function showEnergyPopup(){
    alert("OUT OF ENERGY\nWait 30 Minutes");
}

function startBoost(){
    if(boostCooldown) return;

    boostActive = true;
    boostCooldown = true;

    setTimeout(()=>{
        boostActive = false;
        setTimeout(()=>{
            boostCooldown = false;
        },10000);
    },10000);
}

function updateCountdown(){
    const now = new Date();
    const diff = seasonEnd - now;

    if(diff <= 0){
        location.reload();
        return;
    }

    const d = Math.floor(diff/(1000*60*60*24));
    const h = Math.floor(diff/(1000*60*60))%24;
    const m = Math.floor(diff/(1000*60))%60;
    const s = Math.floor(diff/1000)%60;

    document.getElementById("countdown").innerText =
        `${d}D ${h}H ${m}M ${s}S`;
}

setInterval(updateCountdown,1000);

async function loadLeaderboard(){
    const q = query(collection(db,"players"),
        orderBy("coins","desc"),
        limit(10)
    );

    onSnapshot(q,(snap)=>{
        const list = document.getElementById("leaderboardList");
        list.innerHTML="";
        let rank=1;
        snap.forEach(doc=>{
            const data = doc.data();
            const li=document.createElement("div");
            li.className="leaderRow";
            li.innerText=`#${rank} ${data.username} - ${data.coins}`;
            if(doc.id===userId) li.style.color="gold";
            list.appendChild(li);
            rank++;
        });
    });
}

window.tap = tap;
window.startBoost = startBoost;

initPlayer();
loadLeaderboard();

</script>

<style>

body{
  margin:0;
  background:#2f2f2f;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
}

.app{
  width:100%;
  max-width:360px;
  height:100vh;
  overflow:hidden;
  color:white;
  text-align:center;
}

.header{
  padding:10px;
}

.button{
  width:300px;
  height:300px;
  border-radius:50%;
  background:linear-gradient(45deg,#2196f3,#00bcd4);
  margin:auto;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  cursor:pointer;
  transition:0.1s;
}

.button:active{
  transform:scale(0.95);
}

.energyBar{
  height:10px;
  background:#444;
  margin:10px;
}

.energyFill{
  height:100%;
  background:#4caf50;
  width:100%;
}

.float{
  position:absolute;
  top:50%;
  left:50%;
  animation:floatUp 1s ease-out forwards;
  font-size:22px;
}

@keyframes floatUp{
  from{opacity:1; transform:translate(-50%,0);}
  to{opacity:0; transform:translate(-50%,-100px);}
}

.nav{
  position:absolute;
  bottom:0;
  width:100%;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  background:#222;
}

.leaderRow{
  padding:5px;
}

</style>

</head>

<body>

<div class="app">

<div class="header">
<h2>MOBA COIN</h2>
<div>WEEKLY CHAMPION IS NOW STARTED</div>
<div id="countdown"></div>
<div>TAP, COMPETE & WIN MLBB DIAMOND</div>
<div>1ST 3X WEEKLY PASS | 2ND 2X | 3RD 1X</div>
</div>

<div id="coinDisplay">0</div>

<div class="button" onclick="tap()">TAP</div>

<div>
<div id="energyDisplay"></div>
<div class="energyBar">
<div class="energyFill" id="energyBar"></div>
</div>
<button onclick="startBoost()">5X COIN</button>
</div>

<div id="leaderboardList"></div>

<div class="nav">
<div>HOME</div>
<div>LEADERBOARD</div>
</div>

</div>

</body>
</html>
